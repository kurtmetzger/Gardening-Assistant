<!DOCTYPE html>
<html>
<head>
  <title>Add Plants</title>
  <link rel="stylesheet" href="/css/styles.css" type="text/css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!--For comparing if today's date is in optimal planting range for a plant-->
  <%
  function isDateInRange(today, start, end) {
    if (!start || !end) return false;
    return (start <= end && today >= start && today <= end) ||
           (start > end && (today >= start || today <= end));
    }
  %>

  <!--Searchbar script-->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("searchbar").addEventListener("input", function() {
        //Lowercase for easier matching
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("#almanacTable tbody tr");
        //Tracks how many matches there are
        let rowCount = 0;
    
        rows.forEach(row => {
            //Only compares the name
            const firstCell = row.querySelector("td");
            if (firstCell) {
                //Also compares lowercase
                const text = firstCell.textContent.toLowerCase();
                //Hides row if doesn't contain match
                if (text.includes(filter)) {
                  row.style.display = "";
                  rowCount++;
                } else {
                  row.style.display = "none";
                }
            }
        });
        if (rowCount === 0){
          document.getElementById("noMatches").style.display = "";
        }
    });
  });
  </script>


</head>
<body style="flex-direction: column;">
    <div class="navbar">
        <a href="/">My Garden</a>
        <a class="active" href="/addPlants">Add Plants</a>
        <a class="profile" id="profileButton">Profile</a>
    </div>

<% if (user.plantingZone !== "0") { %>
  <div style="display: flex; flex-direction:column; justify-content: center;align-items: center; margin: 16px;">
    <h1>Showing plants for planting zone, <%= user.plantingZone %>!</h1>
  </div>
  
  <input class="searchbar" type="text" id="searchbar" placeholder="Search..." />
  <table id="almanacTable">
    <thead>
      <tr>
        <th>Plant</th>
        <th>Spring Start</th>
        <th>Spring End</th>
        <th>Fall Start</th>
        <th>Fall End</th>
        <th>Days to Maturity</th>
        <th class="addPlantsButtonsDesktop">Add</th>
      </tr>
    </thead>
    <tbody>
      <% for (let plant in plantingData) { 
          const data = plantingData[plant]; 
          //Compares today's date to plant range to change bg color
          const inSpringRange = isDateInRange(dateToday, data.plantOutdoorsStart, data.plantOutdoorsEnd);
          const inFallRange = isDateInRange(dateToday, data.plantOutdoorsStartFall, data.plantOutdoorsEndFall);
          const inSeason = inSpringRange || inFallRange;
          %>
          
        <tr style="<%= inSeason ? 'background-color: #ccf3ba; color: black;' : '' %>">
          <td><%= plant %></td>
          <td><%= data.plantOutdoorsStart || "—" %></td>
          <td><%= data.plantOutdoorsEnd || "—" %></td>
          <td><%= data.plantOutdoorsStartFall || "—" %></td>
          <td><%= data.plantOutdoorsEndFall || "—" %></td>
          <td><%= data.maturityTime || "—" %></td>
          <td class="addPlantsButtonsDesktop" style="display: flex; flex-direction:row;">
            <form action="/addToGarden" method="POST">
              <input type="hidden" name="datePlanted" value="<%= new Date().toISOString().slice(0, 10) %>">
              <input type="hidden" name="name" value="<%= plant %>">
              <button type="submit" style="<%= inSeason ? 'background-color: #0F433B; color: white;' : '' %>">Planted</button>
            </form>
            <form action="/addToUpcoming" method="POST">
              <input type="hidden" name="datePlanted" value="0">
              <input type="hidden" name="name" value="<%= plant %>">
              <button type="submit" style="<%= inSeason ? 'background-color: #0F433B; color: white;' : '' %>">Upcoming</button>
            </form>
          </td>
        </tr>
        <tr style="<%= inSeason ? 'background-color: #ccf3ba; color: black;' : '' %>;">
          <td colspan="6" class="addPlantsButtonsMobile" style="display:none; ">
            <div style="display:flex; flex-direction:row; justify-content:center;">
              <form action="/addToGarden" method="POST">
                <input type="hidden" name="datePlanted" value="<%= new Date().toISOString().slice(0, 10) %>">
                <input type="hidden" name="name" value="<%= plant %>">
                <button type="submit" style="<%= inSeason ? 'background-color: #0F433B; color: white;' : '' %>">Planted</button>
              </form>
              <form action="/addToUpcoming" method="POST">
                <input type="hidden" name="datePlanted" value="0">
                <input type="hidden" name="name" value="<%= plant %>">
                <button type="submit" style="<%= inSeason ? 'background-color: #0F433B; color: white;' : '' %>">Upcoming</button>
              </form>
            </div>
          </td>
        </tr>
      <% } %>
      <tr id="noMatches" style="display: none;">
        <td colspan="7" style="text-align:center; font-style: italic;">No matches found</td>
      </tr>
    </tbody>
  </table>
<% } else { %>
  <div class="login-register-form">
        <form action="/setZone" method="POST" class="modal-content">
            <h5>Enter Your ZIP Code</h5>
            <p>This lets us determine your Plant Hardiness zone. Only your zone, not your zipcode, is saved.</p>
            <input type="text" name="zipcode" class="form-control" placeholder="e.g. 60601" required pattern="\d{5}">
            <button type="submit" class="btn btn-primary">Save ZIP Code</button>
        </form>
      </div>
<% } %>
    
</body>
</html>